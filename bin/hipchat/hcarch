#!/usr/bin/env python

"""hcarch: archives recent hipchat room histories

Queries all rooms, and then queries the recent history for each of them.

TODO: rename this script?
"""

__author__      = "Joel Dubowy"
__copyright__   = "Copyright (c) 2015 AirFire, PNW, USFS"

from pyairfire import scripting
from pyairfire.hipchat.archive import HipChatArchiver

REQUIRED_ARGS = [
    {
        'short': '-n',
        'long': '--num-days',
        'type': int,
        'dest': 'num_days',
        'help': 'number of days in the past (from now)',
        'action': 'store'
    },
    {
        'short': '-a',
        'long': '--auth-token',
        'dest': 'auth_token',
        'help': 'API Auth token',
        'action': 'store'
    }
]

OPTIONAL_ARGS = [
    {
        'short': '-d',
        'long': '--dest-dir',
        'dest': 'dest_dir',
        'help': 'directory to store archive',
        'action': 'store'
    },
    {
        'short': '-e',
        'long': '--email-recipient',
        'dest': 'email_recipients',
        'help': 'email address to recieve archive',
         # TODO: use action that appends to array but also splits if specified
         #  as comma dlimited list (this action exists somewhere)
        'action': 'append',
        'default': []
    },
    {
        'short': '-r',
        'long': '--room-id',
        'dest': 'room_id',
        'help': 'id of specific room to archive',
        'action': 'store'
    }
    # TODO: add options for smtp config settings
]

if __name__ == "__main__":
    parser, args = scripting.args.parse_args(REQUIRED_ARGS, OPTIONAL_ARGS)
    # TODO: add validation (e.g. either -d or -e must be specified, or both)

    # TODO: set smtp settings in constuction
    archiver = HipChatArchiver(args.auth_token, args.num_days,
        dest_dir=args.dest_dir, email_recipients=args.email_recipients)
    archiver.archive(room_id=args.room_id)

