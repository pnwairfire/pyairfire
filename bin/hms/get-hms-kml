#!/usr/bin/env python

"""gethmsfires: ...
"""

__author__      = "Joel Dubowy"
__copyright__   = "Copyright (c) 2015 AirFire, PNW, USFS"

import logging
import sys
import urllib2
import xmltodict
from argparse import ArgumentParser, RawTextHelpFormatter

EXAMPLES = """

"""

DEFAUlT_URL_ROOT = "http://www.ssd.noaa.gov/PS/FIRE/hms/"

def read_feed(feed):
    if feed in ('smoke', 'fire'):
        feed = "{}{}.kml".format(DEFAUlT_URL_ROOT, feed)
    logging.debug("Getting {}".format(feed))
    f = urllib2.urlopen(feed)
    data = f.read()
    return xmltodict.parse(data)

class outstream(object):
    def __init__(self, file_name):
        self._file_name = file_name
    def __enter__(self):
        if self._file_name:
            self._file =  open(self._file_name, 'w')
            return self._file
        else:
            return sys.stdout

    def __exit__(self, _type, value, tb):
        if _type is not None:
            pass # Exception occurred

        if self._file_name and self._file:
            self._file.close()
        # else, nothing to do for stdout

def parse_args():
    parser = ArgumentParser()
    parser.add_argument('feed', help="'fires', 'smoke', or kml url")
    parser.add_argument('-o', '--output', default=None,
        help="output file; default to stdout")
    parser.add_argument('-l/', '--log-level', default="WARN",
        help="Log level - 'DEBUG', 'INFO', 'WARN', 'ERROR'")
    # TODO: add option to skip stripping of legend and logo
    parser.epilog = EXAMPLES
    return parser.parse_args()

def main():
    args  = parse_args()
    logging.basicConfig(level=getattr(logging, args.log_level))
    xml = read_feed(args.feed)
    # strip logo and legend
    xml['kml']['Document'].pop('ScreenOverlay', None)
    with outstream(args.output) as o:
        o.write(xmltodict.unparse(xml))

if __name__ == "__main__":
    main()
