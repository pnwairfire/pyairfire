#!/usr/bin/env python

"""pre-process-fires: script to combine and filter fires from one or more
BlueSky fire_locations.csv files

See usage string, below, for examples calls
"""

__author__      = "Joel Dubowy"
__copyright__   = "Copyright (c) 2015 AirFire, PNW, USFS"

import sys
import traceback
from optparse import OptionValueError, OptionParser

try:
    from pyairfire.bluesky.merge.fires import FiresMerger
except:
    import os
    root_dir = os.path.abspath(os.path.join(sys.path[0], '../../'))
    sys.path.insert(0, root_dir)
    from pyairfire.bluesky.merge.fires import FiresMerger

USAGE = """%prog filename[:countrycode[,countrycode]] ...

where country codes, if specified, are used as a whitelist for filtering fires.

Note that the headers in the first input file will show up in the output as is.
Any headers in subsequent files that haven't yet been encountered will be sorted
and appended to the current headers.

Example:

Given fire_locations_1.csv:

id,name,lat,lng,date_time,foo,country
12ho123,Fire A,47.12,-118.34,201405310000Z,foo,USA
dsdho123,Fire B,47.22,-118.3423,201405310000Z,foofoo,USA
sldj2343,Fire C,47.22,-118.3423,201405310000Z,oof,MX

and fire_locations_2.csv:

id,name,lat,lng,date_time,baz,bar,country
12ho123,Fire ZZ,50.12,-112.34,201405310000Z,baz,bar,USA
sldj2343,Fire YY,42.22,-109.3423,201405310000Z,zab,rab,MX
dsdho123,Fire XX,37.22,-112.3423,201405310000Z,bazbaz,barbar,CA

And fire_locations_3.csv:

id,name,lat,lng,date_time,bar,baz,aaa,country
sdfdsf,Fire L,44.22,-116.342,201405310000Z,bary,bazy,aaaaa,CA

Running the following:

 > pre-process-fires fire_locations_1.csv fire_locations_2.csv:CA,USA fire_locations_3.csv

Would produce:

id,name,lat,lng,date_time,foo,country,bar,baz,aaa
12ho123,Fire A,47.12,-118.34,201405310000Z,foo,USA,,,
dsdho123,Fire B,47.22,-118.3423,201405310000Z,foofoo,USA,,,
sldj2343,Fire C,47.22,-118.3423,201405310000Z,oof,MX,,,
12ho123,Fire ZZ,50.12,-112.34,201405310000Z,,USA,bar,baz,
dsdho123,Fire XX,37.22,-112.3423,201405310000Z,,CA,barbar,bazbaz,
sdfdsf,Fire L,44.22,-116.342,201405310000Z,,CA,bary,bazy,aaaaa
"""


def error_and_exit(msg):
    print "\n** Error: " + str(msg) + " **\n\nUse '-h' for options and usage\n"
    sys.exit(1)


def main():
    parser = OptionParser(usage=USAGE)
    parser.add_option('-o', '--output-file', #meta=FILE,
        help='output file to contain new set of fires; by default, writes to stdout')
    options, fire_files = parser.parse_args()
    if not fire_files:
        error_and_exit("Specify one or more fire locations csv files")

    try:
        fm = FiresMerger(*fire_files)
        fm.write(options.output_file)
    except Exception, e:
        print traceback.format_exc()
        error_and_exit(e)

if __name__ == "__main__":
    main()
